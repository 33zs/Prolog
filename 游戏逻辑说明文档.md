# 地牢逃脱游戏逻辑说明文档

## 项目概述

这是一个基于Prolog开发的文本冒险游戏，玩家需要在随机生成的地牢中寻找宝藏并逃脱。游戏包含动态敌人AI（使用PDDL规划）、随机事件系统、商店系统等复杂功能。


## 游戏核心逻辑说明

### 1. 地图生成系统

**8x8网格系统**:
- 外层边界（行0、7和列0、7）为墙壁
- 内部6x6区域（行1-6，列1-6）包含36个可探索房间
- 入口固定在(2,2)位置
- 出口固定在(5,5)位置
- 其余34个房间名称随机分配到剩余位置

**路径生成**:
- 基于网格邻接关系自动生成`dynamic_path/3`事实
- 每个房间最多有4个方向（北、南、东、西）的出口

### 2. 敌人AI系统

**守卫(Guard)**:
- 初始类型：`patrol`（巡逻模式）
- 触发条件：
  - 玩家进入守卫所在房间 → 变为`chaser`（追逐模式）
  - 玩家拾取钥匙 → 变为`chaser`
- 行为：使用PDDL规划器生成路径，追逐玩家
- 移动速度：根据难度调整（easy: 50%跳过回合, normal: 1步/回合, hard: 3步/回合）

**小偷(Thief)**:
- 初始类型：`thief`（寻找宝藏模式）
- 触发条件：
  - 玩家持有宝藏 → 变为`chaser`（追逐玩家）
  - 小偷偷到宝藏 → 变为`escaping`（逃向出口）
- 行为：使用PDDL规划器生成路径
- 移动速度：根据难度调整

**PDDL规划集成**:
- 为每个敌人生成PDDL问题文件
- 调用pyperplan求解器生成行动序列
- 执行计划中的行动，如果失败则重新规划

### 3. 物品系统

**物品分类**:
- **武器**: `sword`, `dagger` - 用于攻击敌人
- **防御**: `shield`, `armor` - 减少受到的伤害
- **光源**: `torch`, `lantern` - 揭示陷阱
- **治疗**: `health_potion` (30HP), `food_ration` (15HP)
- **贵重物品**: `gem_ruby`, `gem_emerald`, `gem_sapphire`, `golden_goblet`, `silver_necklace`, `crown`, `ancient_coin` - 可出售换取金币
- **特殊物品**: `key`, `lockpick` - 解锁出口
- **功能物品**: `map_scroll` - 揭示全地图, `bomb` - 攻击敌人, `rope` - 捕获小偷, `magic_ring` - 转换为金币

**物品放置**:
- 随机物品：`torch`, `ancient_book`, `sword`, `shield`, `health_potion`, `rope` - 随机放置在12个候选房间中
- 固定物品：`map_scroll`在`library`, `gold_treasure`在`treasure_room`
- 扩展物品：各种宝石和特殊物品放置在特定房间

### 4. 战斗系统

**攻击守卫**:
- 需要武器（`sword`或`dagger`）
- 命中判定：基础20%或40%（取决于是否有盾牌）+ 难度调整
- 击杀判定：基础50%或70%（取决于是否有盾牌）- 难度调整
- 反击伤害：10或15（取决于是否有盾牌）× 难度倍数

**攻击小偷**:
- 命中判定：35% + 难度调整
- 击杀判定：40% - 难度调整
- 成功后可夺回被偷的宝藏

**防御机制**:
- 盾牌：减少25%伤害
- 盔甲：减少10%伤害
- 两者叠加：减少约35%伤害

### 5. 陷阱系统

**陷阱放置**:
- 每局游戏随机放置2个陷阱
- 候选位置：6个危险房间

**陷阱触发**:
- 无光源：造成5-10点伤害（根据难度调整）
- 有光源：自动发现并避免，不造成伤害

### 6. 商店系统

**位置**: `marketplace`房间

**可购买物品**:
- `health_potion`: 30金币
- `torch`: 15金币
- `rope`: 20金币
- `food_ration`: 10金币
- `bomb`: 50金币
- `map_scroll`: 40金币

**金币获取**:
- 拾取`ancient_coin`: +25金币
- 出售贵重物品：根据物品价值
- 使用`magic_ring`: +50金币
- 随机事件：+10-50金币

### 7. 随机事件系统

**触发概率**: 每回合30% chance

**事件类型**:
1. **脚步声** - 提示守卫方向
2. **发现金币** - 获得10-50金币
3. **地震** - 随机重新定位敌人
4. **幽灵低语** - 提供游戏提示
5. **治疗草药** - 恢复5-15 HP
6. **老鼠偷窃** - 随机物品被偷并移动到相邻房间
7. **火把闪烁** - 30%概率火把熄灭
8. **幸运发现** - 10%概率获得地图，55%概率获得宝石，35%概率获得生锈匕首

### 8. 胜利/失败条件

**胜利条件**:
- 持有`gold_treasure`
- 在`exit_hall`房间
- 出口门已解锁

**失败条件**:
1. 生命值降至0或以下
2. 小偷带着宝藏到达出口
3. 回合数超过100

### 9. 难度系统

**Easy模式**:
- 生命值：150 HP
- 敌人速度：50%概率跳过回合
- 陷阱伤害：5点（基础10的50%）
- 守卫伤害：20点（基础25的80%）
- 战斗加成：+25%命中率，+25%击杀率
- 反击伤害：减半

**Normal模式**:
- 生命值：100 HP
- 敌人速度：1步/回合
- 陷阱伤害：10点
- 守卫伤害：25点
- 无战斗调整

**Hard模式**:
- 生命值：80 HP
- 敌人速度：3步/回合
- 陷阱伤害：20点（基础10的200%）
- 守卫伤害：37点（基础25的150%）
- 战斗惩罚：-25%命中率，-25%击杀率
- 反击伤害：双倍

### 10. 回合推进机制

**`advance_turn`函数执行顺序**:
1. 检查游戏是否结束
2. 增加回合计数
3. 触发随机事件（30%概率）
4. 更新敌人行为（检查触发条件）
5. 执行所有敌人回合
6. 检查游戏状态（胜利/失败条件）

**调用`advance_turn`的操作**:
- 移动（`go/1`）
- 拾取物品（`take/1`）
- 丢弃物品（`drop/1`）
- 使用消耗性物品（`use/1`）- **注意：`use(magic_ring)`和`use(X)`出售功能缺少此调用**
- 购买物品（`buy/1`）

## 代码结构

### 主要模块

1. **`dungeon_escape.pl`** - 核心游戏逻辑
   - 游戏初始化
   - 地图生成
   - 敌人AI
   - 玩家行动
   - 战斗系统
   - 随机事件

2. **`pyperplan_runner.pl`** - PDDL规划器接口
   - 调用pyperplan求解器
   - 解析解决方案文件

3. **`game_web.pl`** - Web界面
   - HTTP服务器
   - HTML生成
   - 游戏状态显示

### 关键谓词

**动态事实**:
- `i_am_at/1` - 玩家位置
- `at/2` - 物品位置
- `holding/1` - 玩家库存
- `adversary_at/2` - 敌人位置
- `adversary_type/2` - 敌人类型
- `adversary_plan/2` - 敌人计划
- `player_health/1` - 玩家生命值
- `turn_count/1` - 回合计数
- `door_locked/1` - 锁定的门
- `trap_location/1` - 陷阱位置
- `player_gold/1` - 玩家金币
- `grid_pos/3` - 网格位置映射
- `dynamic_path/3` - 动态路径

**静态事实**:
- `room/1` - 房间定义
- `object/1` - 物品定义
- `weapon/1` - 武器类型
- `valuable/1` - 贵重物品
- `item_value/2` - 物品价值
- `difficulty_modifier/3` - 难度调整

